<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>ubuntu下安装postfix+mysql+dovecot | SOHOPHP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="alternate" type="application/rss+xml" title="SOHOPHP" href="https://www.sohophp.app/rss.xml" />
  <link rel="alternate" type="application/atom+xml" title="SOHOPHP" href="https://www.sohophp.app/atom.xml" />
  <link rel="alternate" type="application/json" title="SOHOPHP" href="https://www.sohophp.app/feed.json" />

  <meta name="description" content="ubuntu12345678910# 更新系统$ apt update # 查看系统版本$ uname -a # Linux 3fd33fb882db 5.8.0-53-generic #60~20.04.1-Ubuntu SMP Thu May 6 09:52:46 UTC 2021 x86_64 x86_64 x86_64 GNU&#x2F;Linux# 因为我基于docker安装的ubuntu缺少一些">
<meta property="og:type" content="article">
<meta property="og:title" content="ubuntu下安装postfix+mysql+dovecot">
<meta property="og:url" content="https://www.sohophp.app/2021/05/21/docker-ubuntu-postfix-mysql/index.html">
<meta property="og:site_name" content="SOHOPHP">
<meta property="og:description" content="ubuntu12345678910# 更新系统$ apt update # 查看系统版本$ uname -a # Linux 3fd33fb882db 5.8.0-53-generic #60~20.04.1-Ubuntu SMP Thu May 6 09:52:46 UTC 2021 x86_64 x86_64 x86_64 GNU&#x2F;Linux# 因为我基于docker安装的ubuntu缺少一些">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2021-05-21T15:51:54.000Z">
<meta property="article:modified_time" content="2022-06-25T07:15:01.316Z">
<meta property="article:author" content="sohophp@gmail.com">
<meta name="twitter:card" content="summary">
  
    
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
   
    
<link rel="stylesheet" href="/typeface-source-code-pro/index.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  

  <!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-MNJ9H3Z');</script>
  <!-- End Google Tag Manager -->
  
<meta name="generator" content="Hexo 5.4.2"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">SOHOPHP</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://www.sohophp.app"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-docker-ubuntu-postfix-mysql" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/05/21/docker-ubuntu-postfix-mysql/" class="article-date">
  <time class="dt-published" datetime="2021-05-21T15:51:54.000Z" itemprop="datePublished">2021-05-21</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      ubuntu下安装postfix+mysql+dovecot
    </h1>
  

      </header>
    

    <!-- Table of Contents -->
   

    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="ubuntu"><a href="#ubuntu" class="headerlink" title="ubuntu"></a>ubuntu</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 更新系统</span></span><br><span class="line">$ apt update </span><br><span class="line"><span class="comment"># 查看系统版本</span></span><br><span class="line">$ <span class="built_in">uname</span> -a </span><br><span class="line"><span class="comment"># Linux 3fd33fb882db 5.8.0-53-generic #60~20.04.1-Ubuntu SMP Thu May 6 09:52:46 UTC 2021 x86_64 x86_64 x86_64 GNU/Linux</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 因为我基于docker安装的ubuntu缺少一些工具</span></span><br><span class="line"></span><br><span class="line">$ apt install iputils-ping vim net-tools telnet</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="新建mysql数据库-已安装mysql-server，使用docker另一个mysql容器"><a href="#新建mysql数据库-已安装mysql-server，使用docker另一个mysql容器" class="headerlink" title="新建mysql数据库 (已安装mysql-server，使用docker另一个mysql容器)"></a>新建mysql数据库 (已安装mysql-server，使用docker另一个mysql容器)</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建postfix用户，数据库和数据表,</span></span><br><span class="line">mysql&gt; CREATE DATABASE postfix;</span><br><span class="line"><span class="comment"># 选择postfix;</span></span><br><span class="line">mysql&gt; USE postfix;</span><br><span class="line"><span class="comment"># 创建postfix用户密码</span></span><br><span class="line">mysql&gt; CREATE USER postfix@<span class="string">&#x27;%&#x27;</span> IDENTIFIED BY <span class="string">&#x27;postfix&#x27;</span>;</span><br><span class="line"><span class="comment"># 指派权限</span></span><br><span class="line">mysql&gt; GRANT SELECT ,INSERT ,UPDATE ,DELETE ON postfix.* TO <span class="string">&#x27;postfix&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line"><span class="comment"># 刷新</span></span><br><span class="line">mysql&gt; FLUSH PRIVILEGES;</span><br><span class="line"><span class="comment"># 创建 domains表</span></span><br><span class="line">mysql&gt; CREATE TABLE domains (domain varchar(50) NOT NULL,PRIMARY KEY (domain));</span><br><span class="line"><span class="comment"># 创建 forwardings表</span></span><br><span class="line">mysql&gt; CREATE TABLE forwardings (<span class="built_in">source</span> varchar(80) NOT NULL,destination TEXT NOT NULL,PRIMARY KEY(<span class="built_in">source</span>));</span><br><span class="line"><span class="comment"># 创建 users表</span></span><br><span class="line">mysql&gt; CREATE TABLE <span class="built_in">users</span> (email varchar(80) NOT NULL,`password` varchar(64) NOT NULL, quota int(10) default <span class="string">&#x27;104857600&#x27;</span> , PRIMARY KEY (email));</span><br><span class="line"><span class="comment"># 创建 transport表</span></span><br><span class="line">mysql&gt; CREATE TABLE transport (domain varchar(128) NOT NULL default <span class="string">&#x27;&#x27;</span>,transport varchar(128) NOT NULL default <span class="string">&#x27;&#x27;</span>,UNIQUE KEY domain (domain));</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>测试数据</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 域名</span></span><br><span class="line">mysql&gt; insert into domains values (<span class="string">&#x27;postfix.local&#x27;</span>);</span><br><span class="line"><span class="comment"># 邮箱用户</span></span><br><span class="line">mysql&gt; insert into <span class="built_in">users</span> values (<span class="string">&#x27;user1@postfix.local&#x27;</span>,ENCRYPT(<span class="string">&#x27;user1&#x27;</span>),104857600);</span><br><span class="line"><span class="comment"># 创建邮件转发，多个邮箱地址使用,隔开</span></span><br><span class="line">mysql&gt; insert into forwardings values(<span class="string">&#x27;user2@postfix.local&#x27;</span>,<span class="string">&#x27;user1@postfix.local,user3@postfix.local&#x27;</span>);</span><br><span class="line"><span class="comment"># 转发所有邮件到另外的邮件服务器</span></span><br><span class="line"><span class="comment">#INSERT INTO transport VALUES (&#x27;domain.com&#x27;, &#x27;smtp:server2.domain.com&#x27;);</span></span><br></pre></td></tr></table></figure>
<h2 id="安装postfix"><a href="#安装postfix" class="headerlink" title="安装postfix"></a>安装postfix</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#安装依赖</span></span><br><span class="line">$ apt install openssl telnet libsasl2-2 libsasl2-modules libsasl2-modules-sql sasl2-bin libpam-mysql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装postfix</span></span><br><span class="line">$ apt install postfix postfix-mysql postfix-doc mailutils</span><br><span class="line"> </span><br><span class="line"><span class="comment"># General type of mail configuration 输入数字 2 （Internet Site）</span></span><br><span class="line"><span class="comment"># System Mail Name 输入 postfix.local </span></span><br><span class="line"><span class="comment"># Geographic area 时区输入数字 6 (Asia)</span></span><br><span class="line"><span class="comment"># Time Zone 输入数字 70 (Shanghai)</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h2 id="修改配置"><a href="#修改配置" class="headerlink" title="修改配置"></a>修改配置</h2><p>虚拟domain配置文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vim /etc/postfix/mysql-virtual-domains.cf</span><br></pre></td></tr></table></figure>
<p>内容：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">user = postfix</span><br><span class="line">password = postfix</span><br><span class="line">dbname = postfix</span><br><span class="line">query = SELECT domain AS virtual FROM domains WHERE domain = <span class="string">&#x27;%s&#x27;</span></span><br><span class="line">hosts = 172.18.0.136</span><br></pre></td></tr></table></figure>
<p>虚拟forwarding配置文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ vim /etc/postfix/mysql-virtual-forwardings.cf</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>内容</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">user = postfix</span><br><span class="line">password = postfix</span><br><span class="line">dbname = postfix</span><br><span class="line">query = SELECT destination FROM forwardings WHERE <span class="built_in">source</span>=<span class="string">&#x27;%s&#x27;</span></span><br><span class="line">hosts = 172.18.0.136</span><br></pre></td></tr></table></figure>
<p>虚拟mailbox配置文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vim /etc/postfix/mysql-virtual-mailboxes.cf</span><br></pre></td></tr></table></figure>
<p>内容</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">user = postfix</span><br><span class="line">password = postfix</span><br><span class="line">dbname = postfix</span><br><span class="line">query = SELECT CONCAT(SUBSTRING_INDEX (email,<span class="string">&#x27;@&#x27;</span>,-1),<span class="string">&#x27;/&#x27;</span>,SUBSTRING_INDEX(email,<span class="string">&#x27;@&#x27;</span>,1),<span class="string">&#x27;/&#x27;</span>) FROM <span class="built_in">users</span> WHERE email=<span class="string">&#x27;%s&#x27;</span></span><br><span class="line">hosts = 172.18.0.136</span><br></pre></td></tr></table></figure>

<p>虚拟email2email配置文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/postfix/mysql-virtual-email2email.cf</span><br></pre></td></tr></table></figure>
<p>内容</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">user = postfix</span><br><span class="line">password = postfix</span><br><span class="line">dbname = postfix</span><br><span class="line">query = SELECT email FROM <span class="built_in">users</span> WHERE email=<span class="string">&#x27;%s&#x27;</span></span><br><span class="line">hosts = 172.18.0.136</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vim /etc/postfix/mysql-virtual-mydestination.cf</span><br></pre></td></tr></table></figure>
<p>内容</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">user = postfix</span><br><span class="line">password = postfix</span><br><span class="line">dbname = postfix</span><br><span class="line">table = transport</span><br><span class="line">select_field = domain</span><br><span class="line">where_field = domain</span><br><span class="line">hosts = 172.18.0.136</span><br></pre></td></tr></table></figure>

<p>修改配置文件权限</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改/etc/postfix/mysql-virtual-*.cf 用户组为postfix</span></span><br><span class="line">$ <span class="built_in">chgrp</span> postfix /etc/postfix/mysql-virtual-*.cf</span><br><span class="line"><span class="comment"># 禁止other用户访问</span></span><br><span class="line">$ <span class="built_in">chmod</span> o= /etc/postfix/mysql-virtual-*.cf</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>创建证书</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">$ <span class="built_in">mkdir</span> /etc/postfix/certs</span><br><span class="line">$ <span class="built_in">cd</span> /etc/postfix/certs</span><br><span class="line"><span class="comment"># 创建证书</span></span><br><span class="line">$ openssl req -new -outform PEM -out smtpd.cert -newkey rsa:2048 -nodes -keyout smtpd.key -keyform PEM -days 3650 -x509</span><br><span class="line"><span class="comment"># 修改权限</span></span><br><span class="line">$ <span class="built_in">chmod</span> o= smtpd.key</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>创建用户</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ groupadd -g 5000 vmail</span><br><span class="line">$ useradd -c <span class="string">&#x27;vmail&#x27;</span> -g vmail -u 5000 vmail -d /home/vmail -m</span><br></pre></td></tr></table></figure>

<p>使用postconf 配置main.cf</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">$ postconf -e <span class="string">&#x27;myhostname = postfix.local&#x27;</span></span><br><span class="line">$ postconf -e <span class="string">&#x27;mydestination = localhost , proxy:mysql:/etc/postfix/mysql-virtual-mydestination.cf&#x27;</span></span><br><span class="line">$ postconf -e <span class="string">&#x27;mynetworks = 127.0.0.0/8, 172.18.0.125&#x27;</span> </span><br><span class="line">$ postconf -e <span class="string">&#x27;message_size_limit = 30720000&#x27;</span></span><br><span class="line">$ postconf -e <span class="string">&#x27;virtual_alias_domains =&#x27;</span></span><br><span class="line">$ postconf -e <span class="string">&#x27;virtual_alias_maps = proxy:mysql:/etc/postfix/mysql-virtual-forwardings.cf, mysql:/etc/postfix/mysql-virtual-email2email.cf&#x27;</span></span><br><span class="line">$ postconf -e <span class="string">&#x27;virtual_mailbox_domains = proxy:mysql:/etc/postfix/mysql-virtual-domains.cf&#x27;</span></span><br><span class="line">$ postconf -e <span class="string">&#x27;virtual_mailbox_maps = proxy:mysql:/etc/postfix/mysql-virtual-mailboxes.cf&#x27;</span></span><br><span class="line"></span><br><span class="line">$ postconf -e <span class="string">&#x27;virtual_mailbox_base = /home/vmail&#x27;</span></span><br><span class="line">$ postconf -e <span class="string">&#x27;virtual_uid_maps = static:5000&#x27;</span></span><br><span class="line">$ postconf -e <span class="string">&#x27;virtual_gid_maps = static:5000&#x27;</span></span><br><span class="line">$ postconf -e <span class="string">&#x27;smtpd_sasl_auth_enable = yes&#x27;</span></span><br><span class="line">$ postconf -e <span class="string">&#x27;broken_sasl_auth_clients = yes&#x27;</span></span><br><span class="line">$ postconf -e <span class="string">&#x27;smtpd_sasl_authenticated_header = yes&#x27;</span></span><br><span class="line">$ postconf -e <span class="string">&#x27;smtpd_recipient_restrictions = permit_mynetworks, permit_sasl_authenticated, reject_unauth_destination&#x27;</span></span><br><span class="line">$ postconf -e <span class="string">&#x27;smtpd_use_tls = yes&#x27;</span></span><br><span class="line">$ postconf -e <span class="string">&#x27;smtpd_tls_cert_file = /etc/postfix/certs/smtpd.cert&#x27;</span></span><br><span class="line">$ postconf -e <span class="string">&#x27;smtpd_tls_key_file = /etc/postfix/certs/smtpd.key&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 以下为同一行</span></span><br><span class="line">$ postconf -e <span class="string">&#x27;proxy_read_maps = $local_recipient_maps $mydestination $virtual_alias_maps $virtual_alias_domains    $virtual_mailbox_maps $virtual_mailbox_domains $relay_recipient_maps $relay_domains $canonical_maps $sender_canonical_maps $recipient_canonical_maps $relocated_maps $transport_maps $mynetworks &#x27;</span></span><br><span class="line"><span class="comment"># 以上为同一行</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">#其它参考</span></span><br><span class="line"><span class="comment">#  queue_run_delay = 3s          //每3s扫描一次delay的邮件 </span></span><br><span class="line"><span class="comment">#  minimal_backoff_time = 3s         //在3s内不会重发delay的邮件</span></span><br><span class="line"><span class="comment">#  maximal_backoff_time = 6s         //在6s内则一定会重发邮件</span></span><br><span class="line"><span class="comment">#  maximal_queue_lifetime = 12s      //邮件超过12s没有发出，则退信</span></span><br><span class="line"><span class="comment">#  smtpd_sasl_auth_enable = yes      //启动SMTP认证</span></span><br><span class="line"><span class="comment">#  smtpd_sasl_security_options = noanonymous //禁止匿名使用SMTP服务</span></span><br><span class="line"><span class="comment">#  mynetworks = 127.0.0.1        //允许本服务器发送到外网地址</span></span><br><span class="line"><span class="comment">#  smtpd_recipient_restrictions = permit_mynetworks,permit_sasl_authenticated,reject_unauth_destination  //定义地址过滤规则</span></span><br><span class="line"></span><br><span class="line">$ postconf -e <span class="string">&#x27;virtual_transport = dovecot&#x27;</span></span><br><span class="line">$ postconf -e <span class="string">&#x27;local_transport = dovecot&#x27;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>配置saslauthd</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">mkdir</span> -p /var/spool/postfix/var/run/saslauthd</span><br><span class="line">$ <span class="built_in">cp</span> -a /etc/default/saslauthd /etc/default/saslauthd.bak</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vim /etc/default/saslauthd</span><br></pre></td></tr></table></figure>
<p>内容</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">START=<span class="built_in">yes</span></span><br><span class="line">DESC=<span class="string">&quot;SASL Authentication Daemon&quot;</span></span><br><span class="line">NAME=<span class="string">&quot;saslauthd&quot;</span></span><br><span class="line">MECHANISMS=<span class="string">&quot;pam&quot;</span></span><br><span class="line">MECH_OPTIONS=<span class="string">&quot;&quot;</span></span><br><span class="line">THREADS=5</span><br><span class="line">OPTIONS=<span class="string">&quot;-c -m /var/spool/postfix/var/run/saslauthd -r&quot;</span> </span><br></pre></td></tr></table></figure>


<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vim /etc/pam.d/smtp</span><br></pre></td></tr></table></figure>
<p>内容</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">auth    required   pam_mysql.so user=postfix passwd=postfix host=172.18.0.136 db=postfix table=users usercolumn=email passwdcolumn=password crypt=1</span><br><span class="line">account sufficient pam_mysql.so user=postfix passwd=postfix host=172.168.0.136 db=postfix table=users usercolumn=email passwdcolumn=password crypt=1</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vim /etc/postfix/sasl/smtpd.conf</span><br></pre></td></tr></table></figure>
<p>内容</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">pwcheck_method: saslauthd</span><br><span class="line">mech_list: plain login</span><br><span class="line">allow_plaintext: true</span><br><span class="line">auxprop_plugin: sql</span><br><span class="line">sql_engine: mysql</span><br><span class="line">sql_hostnames: 172.18.0.136</span><br><span class="line">sql_user: postfix</span><br><span class="line">sql_passwd: postfix</span><br><span class="line">sql_database: postfix</span><br><span class="line">sql_select: select password from users where email = &#x27;%u@%r&#x27;</span><br></pre></td></tr></table></figure>

<p>修改权限</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">chmod</span> o= /etc/pam.d/smtp</span><br><span class="line">$ <span class="built_in">chmod</span> o= /etc/postfix/sasl/smtpd.conf</span><br></pre></td></tr></table></figure>
<p>postfix加到sasl组</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ adduser postfix sasl</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>重启postfix ,saslauthd</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ /etc/init.d/postfix restart</span><br><span class="line">$ /etc/init.d/saslauthd restart</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://www.sohophp.app/2021/05/21/docker-ubuntu-postfix-mysql/" data-id="cl4tjs08o000jbyrsfbae46tt" data-title="ubuntu下安装postfix+mysql+dovecot" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2021/07/06/it-is-okay/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          it&#39;is okay
        
      </div>
    </a>
  
  
    <a href="/2021/05/03/ubuntu20-install-php7-2/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">ubuntu20 install php7.2</div>
    </a>
  
</nav>

  
</article>



</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Docker/">Docker</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Hexo/">Hexo</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/CentOS/">CentOS</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/PHP/">PHP</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/PHP/Composer/">Composer</a></li></ul></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Apache/" rel="tag">Apache</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CRM/" rel="tag">CRM</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CRS/" rel="tag">CRS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CentOS/" rel="tag">CentOS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CentOS7/" rel="tag">CentOS7</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Centos/" rel="tag">Centos</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Composer/" rel="tag">Composer</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Docker/" rel="tag">Docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hexo/" rel="tag">Hexo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Httpd/" rel="tag">Httpd</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Https/" rel="tag">Https</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/" rel="tag">Linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MariaDB/" rel="tag">MariaDB</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Markdown/" rel="tag">Markdown</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ModSecurity/" rel="tag">ModSecurity</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MySQL/" rel="tag">MySQL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PHP/" rel="tag">PHP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PHP-FPM/" rel="tag">PHP-FPM</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PHP7/" rel="tag">PHP7</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PHP7-2/" rel="tag">PHP7.2</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SELinux/" rel="tag">SELinux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SSL/" rel="tag">SSL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Ubuntu/" rel="tag">Ubuntu</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Ubuntu-WSL/" rel="tag">Ubuntu,WSL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/WSL/" rel="tag">WSL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/" rel="tag">docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/" rel="tag">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/php/" rel="tag">php</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ubuntu/" rel="tag">ubuntu</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Apache/" style="font-size: 16.67px;">Apache</a> <a href="/tags/CRM/" style="font-size: 10px;">CRM</a> <a href="/tags/CRS/" style="font-size: 10px;">CRS</a> <a href="/tags/CentOS/" style="font-size: 20px;">CentOS</a> <a href="/tags/CentOS7/" style="font-size: 16.67px;">CentOS7</a> <a href="/tags/Centos/" style="font-size: 10px;">Centos</a> <a href="/tags/Composer/" style="font-size: 10px;">Composer</a> <a href="/tags/Docker/" style="font-size: 10px;">Docker</a> <a href="/tags/Hexo/" style="font-size: 10px;">Hexo</a> <a href="/tags/Httpd/" style="font-size: 13.33px;">Httpd</a> <a href="/tags/Https/" style="font-size: 10px;">Https</a> <a href="/tags/Linux/" style="font-size: 16.67px;">Linux</a> <a href="/tags/MariaDB/" style="font-size: 10px;">MariaDB</a> <a href="/tags/Markdown/" style="font-size: 10px;">Markdown</a> <a href="/tags/ModSecurity/" style="font-size: 10px;">ModSecurity</a> <a href="/tags/MySQL/" style="font-size: 13.33px;">MySQL</a> <a href="/tags/PHP/" style="font-size: 16.67px;">PHP</a> <a href="/tags/PHP-FPM/" style="font-size: 10px;">PHP-FPM</a> <a href="/tags/PHP7/" style="font-size: 10px;">PHP7</a> <a href="/tags/PHP7-2/" style="font-size: 10px;">PHP7.2</a> <a href="/tags/SELinux/" style="font-size: 10px;">SELinux</a> <a href="/tags/SSL/" style="font-size: 10px;">SSL</a> <a href="/tags/Ubuntu/" style="font-size: 10px;">Ubuntu</a> <a href="/tags/Ubuntu-WSL/" style="font-size: 10px;">Ubuntu,WSL</a> <a href="/tags/WSL/" style="font-size: 10px;">WSL</a> <a href="/tags/docker/" style="font-size: 10px;">docker</a> <a href="/tags/linux/" style="font-size: 10px;">linux</a> <a href="/tags/php/" style="font-size: 10px;">php</a> <a href="/tags/ubuntu/" style="font-size: 10px;">ubuntu</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/04/">April 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/07/">July 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/05/">May 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">March 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">February 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2022/04/30/Ubuntu20-04%E5%AE%89%E8%A3%85PHP7-2%E5%92%8CPHP8-1/">WSL-Ubuntu20.04 安装 Apache2.4 + MySQL8.0 + PHP7.2 和 PHP8.1 ,composer,git 开发环境</a>
          </li>
        
          <li>
            <a href="/2022/04/29/Ubuntu-WSL-chmod-Operation-not-permitted/">Ubuntu (WSL) chmod(): Operation not permitted</a>
          </li>
        
          <li>
            <a href="/2021/07/06/it-is-okay/">it&#39;is okay</a>
          </li>
        
          <li>
            <a href="/2021/05/21/docker-ubuntu-postfix-mysql/">ubuntu下安装postfix+mysql+dovecot</a>
          </li>
        
          <li>
            <a href="/2021/05/03/ubuntu20-install-php7-2/">ubuntu20 install php7.2</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2022 sohophp@gmail.com<br>
      Powered by  sohophp.app
    </div>
  </div>
</footer>


<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MNJ9H3Z"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>